<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicFlow Command Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #212529; color: #e9ecef; font-family: 'Segoe UI', sans-serif; }
        .navbar { border-bottom: 3px solid #0d6efd; background-color: #1a1d20 !important; }
        .nav-tabs .nav-link { color: #adb5bd; border: 1px solid transparent; }
        .nav-tabs .nav-link.active { background-color: #2c3034; color: #fff; border-color: #373b3e #373b3e #2c3034; }
        .card { background-color: #2c3034; border: 1px solid #373b3e; }
        .table { color: #ddd; }
        .table-hover tbody tr:hover { color: #fff; background-color: #373b3e; }
        
        /* Map Container */
        #liveMap { height: 550px; width: 100%; border-radius: 6px; }
        
        /* Pulse Animation */
        .pulse-red { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark px-4 mb-4 shadow-sm">
    <div class="d-flex align-items-center">
        <i class="fas fa-network-wired text-primary fa-lg me-3"></i>
        <div>
            <h5 class="mb-0 text-white fw-bold">CivicFlow <span class="badge bg-danger ms-2" style="font-size:0.6rem; vertical-align: top;">ADMIN</span></h5>
            <small class="text-muted" style="font-size: 0.75rem;">AI-Powered Governance Dashboard</small>
        </div>
    </div>
    
    <div class="d-flex align-items-center">
        <div class="input-group input-group-sm me-4">
            <span class="input-group-text bg-dark text-secondary border-secondary">View City</span>
            <select class="form-select bg-dark text-white border-secondary" onchange="switchMapCity(this.value)">
                <option value="Hyderabad">Hyderabad</option>
                <option value="Bangalore">Bangalore</option>
            </select>
        </div>
        
        <span id="crit-badge" class="badge bg-secondary me-3 p-2">0 Critical</span>
        <span class="text-success small"><i class="fas fa-circle me-1"></i> Online</span>
    </div>
</nav>

<div class="container-fluid px-4">
    
    <ul class="nav nav-tabs mb-0" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="feed-tab" data-bs-toggle="tab" data-bs-target="#feed-pane" type="button">
                <i class="fas fa-list-ul me-2"></i>Live Incident Feed
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-pane" type="button">
                <i class="fas fa-map-marked-alt me-2"></i>Geospatial Grid
            </button>
        </li>
    </ul>

    <div class="tab-content bg-dark border border-top-0 border-secondary p-4 rounded-bottom shadow-lg">
        
        <div class="tab-pane fade show active" id="feed-pane">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Location</th>
                                    <th>Issue</th>
                                    <th>AI Analysis</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="reportTable">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="map-pane">
            <div class="card border-0">
                <div class="card-body p-1 bg-black rounded">
                    <div id="liveMap"></div>
                </div>
                <div class="card-footer bg-dark border-top border-secondary text-center d-flex justify-content-between">
                    <small class="text-muted"><i class="fas fa-satellite me-2"></i>Google Satellite Link Active</small>
                    <small class="text-info" id="current-view-label">Viewing: Hyderabad</small>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Ticket Details <span id="modal-id" class="text-muted"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <small class="text-muted">LOCATION</small>
                        <div class="fw-bold"><i class="fas fa-map-pin text-danger me-1"></i> <span id="modal-loc"></span></div>
                    </div>
                    <div class="col-6 mb-3">
                        <small class="text-muted">ISSUE TYPE</small>
                        <div class="fw-bold" id="modal-issue"></div>
                    </div>
                </div>
                <div class="p-3 bg-secondary bg-opacity-10 border border-secondary rounded mb-3">
                    <small class="text-info fw-bold mb-2 d-block">AI SEMANTIC ANALYSIS</small>
                    <span id="modal-desc" class="fst-italic text-light small"></span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">RISK SCORE</small>
                        <div id="modal-score" class="h4 text-warning mb-0"></div>
                    </div>
                    <div>
                        <small class="text-muted">CURRENT STATUS</small>
                        <div id="modal-status" class="badge bg-secondary d-block p-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="dispatchTeam()">
                    <i class="fas fa-paper-plane me-2"></i>Dispatch Unit
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQVurH8PhEZ2qioz5do8L_rAsB9wkI_MY&callback=initMap">
</script>

<script>
    // --- MAP CONFIGURATION ---
    var map;
    var markers = {};
    let currentViewCity = "Hyderabad";

    const cityCenters = {
        "Hyderabad": { lat: 17.4000, lng: 78.4500 },
        "Bangalore": { lat: 12.9716, lng: 77.5946 }
    };

    const zoneCoordinates = {
        "Hyderabad": {
            "School Zone": { lat: 17.4448, lng: 78.3498 },      
            "Hospital Area": { lat: 17.4399, lng: 78.4983 },
            "Main Highway": { lat: 17.3850, lng: 78.4867 },
            "Residential Area": { lat: 17.4065, lng: 78.4772 },
            "Marketplace": { lat: 17.4239, lng: 78.4738 }
        },
        "Bangalore": {
            "School Zone": { lat: 12.9344, lng: 77.6112 },      
            "Hospital Area": { lat: 12.9382, lng: 77.6221 },
            "Main Highway": { lat: 12.9279, lng: 77.6271 },
            "Residential Area": { lat: 12.9250, lng: 77.5938 },
            "Marketplace": { lat: 12.9352, lng: 77.6245 }
        }
    };

    // Initialize Google Map
    function initMap() {
        map = new google.maps.Map(document.getElementById("liveMap"), {
            zoom: 12,
            center: cityCenters["Hyderabad"],
            mapId: "DEMO_MAP_ID", // Optional: Use 'DEMO_MAP_ID' for default styling
            styles: [ // Dark Mode Style
                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                {
                    featureType: "administrative.locality",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#d59563" }],
                },
                {
                    featureType: "road",
                    elementType: "geometry",
                    stylers: [{ color: "#38414e" }],
                },
                {
                    featureType: "road",
                    elementType: "geometry.stroke",
                    stylers: [{ color: "#212a37" }],
                },
                {
                    featureType: "water",
                    elementType: "geometry",
                    stylers: [{ color: "#17263c" }],
                },
            ],
        });
    }

    function switchMapCity(cityName) {
        currentViewCity = cityName;
        document.getElementById('current-view-label').innerText = "Viewing: " + cityName;
        
        // Google Maps Pan Animation
        map.panTo(cityCenters[cityName]);
        map.setZoom(12);
    }

    function plotOnMap(reports) {
        let cityZones = zoneCoordinates[currentViewCity];

        reports.forEach(r => {
            if (!markers[r.id] && cityZones[r.loc]) {
                let coords = cityZones[r.loc];
                // Jitter
                let lat = coords.lat + (Math.random() * 0.005 - 0.0025);
                let lng = coords.lng + (Math.random() * 0.005 - 0.0025);
                
                // Color logic
                let iconUrl = "http://maps.google.com/mapfiles/ms/icons/green-dot.png";
                if(r.score > 80) iconUrl = "http://maps.google.com/mapfiles/ms/icons/red-dot.png";
                else if(r.score > 50) iconUrl = "http://maps.google.com/mapfiles/ms/icons/orange-dot.png";

                const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: r.issue,
                    icon: iconUrl,
                    animation: google.maps.Animation.DROP
                });

                const infowindow = new google.maps.InfoWindow({
                    content: `
                        <div style="color:black">
                            <strong>${r.issue}</strong><br>
                            Risk: ${r.score}<br>
                            ${r.loc}
                        </div>`
                });

                marker.addListener("click", () => {
                    infowindow.open(map, marker);
                });

                markers[r.id] = marker;
            }
        });
    }

    // --- DASHBOARD LOGIC ---
    let currentReportId = null;

    function showDetails(id, loc, issue, desc, score, status) {
        currentReportId = id;
        document.getElementById('modal-id').innerText = "#" + id;
        document.getElementById('modal-loc').innerText = loc;
        document.getElementById('modal-issue').innerText = issue;
        document.getElementById('modal-desc').innerText = desc || "No description provided.";
        document.getElementById('modal-score').innerText = score + "/100";
        document.getElementById('modal-status').innerText = status;
        
        let statusBadge = document.getElementById('modal-status');
        if(status === "Pending") statusBadge.className = "badge bg-warning text-dark d-block p-2";
        else statusBadge.className = "badge bg-success d-block p-2";

        var myModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        myModal.show();
    }

    function dispatchTeam() {
        var myModalEl = document.getElementById('detailsModal');
        var modal = bootstrap.Modal.getInstance(myModalEl);
        modal.hide();
        alert("âœ… DISPATCH SENT!\nField Unit assigned to Ticket #" + currentReportId);
    }

    async function loadStats() {
        try {
            const res = await fetch('http://127.0.0.1:8000/admin_stats');
            const data = await res.json();
            
            const tbody = document.getElementById('reportTable');
            tbody.innerHTML = '';
            
            // Critical Badge Logic
            let badge = document.getElementById('crit-badge');
            badge.innerText = data.critical + " Critical";
            if(data.critical > 0) {
                badge.className = "badge bg-danger me-3 p-2 pulse-red";
            } else {
                badge.className = "badge bg-secondary me-3 p-2";
            }

            // Populate Table
            data.reports.forEach(r => {
                let priorityClass = r.score > 80 ? 'bg-danger pulse-red' : (r.score > 50 ? 'bg-warning text-dark' : 'bg-success');
                let shortDesc = r.desc ? (r.desc.length > 25 ? r.desc.substring(0,25)+"..." : r.desc) : "-";

                let row = `
                <tr>
                    <td><small class="text-muted">#${r.id}</small></td>
                    <td>${r.loc}</td>
                    <td><span class="fw-bold">${r.issue}</span></td>
                    <td><small class="text-secondary">${shortDesc}</small></td>
                    <td><span class="badge ${priorityClass}">${r.score}</span></td>
                    <td>${r.status}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-light" onclick="showDetails(${r.id}, '${r.loc}', '${r.issue}', '${r.desc}', ${r.score}, '${r.status}')">
                            Review
                        </button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // Update Map if it's loaded
            if(map) {
                plotOnMap(data.reports);
            }

        } catch(e) { console.log("Waiting for Backend..."); }
    }

    // Load stats periodically
    setInterval(loadStats, 2000);
    loadStats();
</script>

</body>
</html>